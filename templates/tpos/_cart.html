<div>
  <q-drawer
    side="right"
    v-model="cartDrawer"
    show-if-above
    bordered
    :width="drawerWidth"
    :breakpoint="1024"
  >
    <div class="row full-width q-pa-md">
      <div class="absolute-top-right q-pa-md">
        <q-btn @click="cartDrawer = !cartDrawer" icon="close" flat round
          ><q-tooltip>Hide Cart</q-tooltip></q-btn
        >
      </div>
      <div class="col-12 text-center">
        <h3 class="q-mb-md" v-text="totalFormatted"></h3>
        <h5 v-show="!denomIsSats" class="q-mt-none q-mb-sm">
          <span v-text="totalfsat"></span><small> sat</small>
        </h5>
      </div>
      <div class="col-12" :style="drawerItemsHeight">
        <table class="table full-width" virtual-scroll>
          <colgroup>
            <col width="50%" />
            <col width="25%" />
            <col width="0%" />
            <col width="0%" />
          </colgroup>
          <tbody>
            <tr v-for="item in [...cart.values()]" :key="item.id">
              <td
                class="text-bold ellipsis"
                style="
                  white-space: nowrap;
                  text-overflow: ellipsis;
                  overflow: hidden;
                  max-width: 1px;
                "
              >
                <span v-text="item.title"></span>
              </td>
              <td>
                <div class="flex justify-evenly" style="align-items: center">
                  <q-btn
                    @click="removeFromCart(item)"
                    flat
                    dense
                    round
                    size="sm"
                    icon="remove"
                    :disabled="item.quantity == 1"
                  ></q-btn>
                  <div class="text-center">
                    <span class="text-bold" v-text="item.quantity"></span>
                  </div>
                  <q-btn
                    @click="addToCart(item)"
                    flat
                    dense
                    round
                    size="sm"
                    icon="add"
                  ></q-btn>
                </div>
              </td>
              <td>
                <div class="text-center">
                  <span
                    class="cursor-pointer text-secondary"
                    @click="promptItemPrice(item)"
                    v-text="item.formattedPrice"
                  ></span>
                </div>
              </td>
              <td>
                <q-btn
                  @click="removeFromCart(item, item.quantity)"
                  color="negative"
                  size="sm"
                  round
                  icon="delete"
                ></q-btn>
              </td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>
    <div class="row q-col-gutter-md q-pa-md absolute-bottom q-mb-lg">
      <div v-if="total > 0" class="col-12">
        <q-list dense padding class="rounded-borders">
          <q-item>
            <q-item-section> Subtotal </q-item-section>
            <q-item-section side v-text="taxSubtotal"></q-item-section>
          </q-item>
          <q-item>
            <q-item-section
              v-text="`Tax ${taxInclusive ? '(incl.)' : ''}`"
            ></q-item-section>
            <q-item-section side v-text="formattedCartTax"></q-item-section>
          </q-item>
          <q-item v-if="addedAmount > 0">
            <q-item-section> Manual Input </q-item-section>
            <q-item-section
              side
              v-text="formatAmount(addedAmount, currency)"
            ></q-item-section>
          </q-item>
          <q-separator></q-separator>
          <q-item>
            <q-item-section> Total </q-item-section>
            <q-item-section side v-text="totalFormatted"></q-item-section>
          </q-item>
        </q-list>
      </div>
      <div class="col-12 col-sm-6">
        <q-btn
          class="full-width"
          @click="submitForm"
          color="positive"
          label="Pay"
          padding="md"
          :disabled="cart.size == 0"
        ></q-btn>
      </div>
      <div class="col-12 col-sm-6">
        <q-btn
          class="full-width"
          @click="clearCart"
          color="negative"
          label="Clear cart"
          padding="md"
        ></q-btn>
      </div>
    </div>
  </q-drawer>
  <div class="row items-center q-pt-md q-pl-md q-pr-md q-pb-xs q-gutter-sm">
    <!-- left: don't stretch -->
    <q-btn
      class="col-auto self-center"
      round
      padding="sm"
      color="primary"
      :icon="isGridView ? 'view_list' : 'grid_view'"
      @click="isGridView = !isGridView"
    ></q-btn>
    <q-space></q-space>
    <!-- middle: grows -->
    <q-input
      class="col-6 col-sm-4 col-md-3 col-lg-2"
      v-model="searchTerm"
      label="Filter"
      dense
    >
      <q-icon
        v-if="searchTerm !== ''"
        name="close"
        @click="searchTerm = ''"
        class="cursor-pointer"
      ></q-icon>
    </q-input>
    <div class="col-auto lt-md">{% include "tpos/_options_fab.html" %}</div>

    <!-- categories: drop under on xs -->
    <div
      class="col-12 col-sm-auto row wrap justify-center q-pa-sm q-mx-md"
      v-if="categories && categories.length"
    >
      <template v-for="category in Array.from(categories.values())">
        <q-btn
          class="q-ml-xs"
          :color="setColor(category)"
          :label="category"
          @click="handleCategoryBtn(category)"
        ></q-btn>
      </template>
    </div>
    <q-space></q-space>
    <!-- right: don't stretch -->
    <div class="col-auto gt-sm">{% include "tpos/_options_fab.html" %}</div>
  </div>

  <div class="q-mx-auto q-pa-md" :class="{'dimmed': moreBtn}">
    <!-- Items List Large -->
    <div v-if="isGridView" class="flex justify-center q-col-gutter-sm q-mt-md">
      <div
        style="height: 150px; width: 150px"
        v-for="item in filteredItems"
        :key="item.id"
      >
        <q-card class="full-height" flat bordered v-ripple>
          <div @click="addToCart(item)">
            <q-img :src="item.image || null" :ratio="4/3" fit="contain">
            </q-img>

            <span class="item-grid-title" dense v-text="item.title"></span>

            <q-separator
              class="q-pt-xs"
              :color="setColor(item.categories[0])"
            ></q-separator>
          </div>
        </q-card>
      </div>
    </div>
    <!-- Items List Small -->
    <q-list v-else class="col-12">
      <q-item v-for="item in filteredItems" :key="item.id" v-ripple>
        <q-item-section avatar @click="addToCart(item)">
          <q-avatar rounded>
            <q-img
              v-if="item.image"
              :class="{'bg-grey': !item.image}"
              :ratio="1"
              :src="item.image"
              fit="contain"
            ></q-img>

            <q-icon
              v-else
              name="sell"
              size="xs"
              class="absolute-center text-grey"
            ></q-icon>
            <q-badge floating :color="setColor(item.categories[0])"></q-badge>
          </q-avatar>
        </q-item-section>

        <q-item-section @click="addToCart(item)">
          <q-item-label
            class="text-subtitle1 ellipsis"
            v-text="item.title"
          ></q-item-label>
          <q-item-label class="text-subtitle2">
            <span v-text="item.formattedPrice"></span>
            <span v-if="item.tax || taxDefault" class="text-caption">
              <span
                v-text="`(tax ${taxInclusive ? 'incl.' : 'excl.'} ${item.tax || taxDefault}%)`"
              ></span> </span
          ></q-item-label>
        </q-item-section>
        <q-item-section side>
          <div class="flex">
            <q-btn
              :outline="itemCartQty(item.id) == 0"
              round
              size="sm"
              color="secondary"
              icon="remove"
              @click="removeFromCart(item)"
              :disabled="!itemCartQty(item.id)"
            ></q-btn>
            <div class="text-subtitle2 text-center q-mx-sm" style="width: 2ch">
              <span v-text="itemCartQty(item.id)"></span>
            </div>
            <q-btn
              round
              size="sm"
              color="secondary"
              icon="add"
              @click="addToCart(item)"
            ></q-btn>
          </div>
        </q-item-section>
      </q-item>
    </q-list>
  </div>
  <q-page-sticky position="bottom" :offset="[0, 22]" v-if="cart.size > 0">
    <q-btn
      color="primary"
      size="sm"
      padding="md"
      label="Hold Cart"
      style="width: 90px"
      class="q-mr-sm"
      :disabled="cart.size == 0"
      @click="holdCart"
    ></q-btn>
    <q-btn
      color="primary"
      size="sm"
      padding="md"
      label="Checkout"
      style="width: 90px"
      @click="cartDrawer = !cartDrawer"
    ></q-btn>
  </q-page-sticky>
</div>
